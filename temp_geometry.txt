
function generateQuestion(level, topic, gradeKey, mixedOps = null) {
  const isMixed = topic === "mixed";
  
  let selectedTopic;
  if (isMixed) {
    let availableTopics;
    if (mixedOps) {
      availableTopics = Object.entries(mixedOps)
        .filter(([t, selected]) => selected && t !== "mixed")
        .map(([t]) => t);
    } else {
      availableTopics = GRADES[gradeKey].topics.filter((t) => t !== "mixed");
    }
    if (!availableTopics || availableTopics.length === 0) {
      availableTopics = GRADES[gradeKey].topics.filter((t) => t !== "mixed");
    }
    selectedTopic =
      availableTopics[Math.floor(Math.random() * availableTopics.length)];
  } else {
    selectedTopic = topic;
  }

  const availableShapes = getShapesForTopic(gradeKey, selectedTopic);
  const shape =
    availableShapes.length > 0
      ? availableShapes[Math.floor(Math.random() * availableShapes.length)]
      : null;

  let question;
  let correctAnswer;
  let params = {};

  const roundTo = level.decimals ? 2 : 0;
  const round = (num) =>
    Math.round(num * Math.pow(10, roundTo)) / Math.pow(10, roundTo);

  // לאפשר תרגילי מילים בעיקר לכיתות גבוהות יותר
  const allowStory = gradeKey === "g5_6" || gradeKey === "g7_8";

  switch (selectedTopic) {
    // ===================== AREA =====================
    case "area": {
      switch (shape) {
        case "square": {
          const side = Math.floor(Math.random() * level.maxSide) + 1;
          const useStory = allowStory && Math.random() < 0.4;

          params = { side, kind: useStory ? "story_square_area" : "square_area" };
          correctAnswer = round(side * side);

          if (useStory) {
            question = `לליאו יש גינה בצורת ריבוע, אורך כל צלע הוא ${side} מטר. כמה מטרים רבועים שטח הגינה?`;
          } else {
            question = `מה השטח של ריבוע עם צלע ${side}?`;
          }
          break;
        }

        case "rectangle": {
          const length = Math.floor(Math.random() * level.maxSide) + 1;
          const width = Math.floor(Math.random() * level.maxSide) + 1;
          const useStory = allowStory && Math.random() < 0.5;

          params = {
            length,
            width,
            kind: useStory ? "story_rectangle_area" : "rectangle_area",
          };
          correctAnswer = round(length * width);

          if (useStory) {
            question = `רצפת חדר של ליאו היא מלבן באורך ${length} מטר וברוחב ${width} מטר. מה שטח הרצפה במטרים רבועים?`;
          } else {
            question = `מה השטח של מלבן עם אורך ${length} ורוחב ${width}?`;
          }
          break;
        }

        case "triangle": {
          const base = Math.floor(Math.random() * level.maxSide) + 1;
          const height = Math.floor(Math.random() * level.maxSide) + 1;
          const useStory = allowStory && Math.random() < 0.3;

          params = {
            base,
            height,
            kind: useStory ? "story_triangle_area" : "triangle_area",
          };
          correctAnswer = round((base * height) / 2);

          if (useStory) {
            question = `גג של בית הוא משולש עם בסיס ${base} מטר וגובה ${height} מטר. מה שטח הגג בצד אחד?`;
          } else {
            question = `מה השטח של משולש עם בסיס ${base} וגובה ${height}?`;
          }
          break;
        }

        case "parallelogram": {
          const base = Math.floor(Math.random() * level.maxSide) + 1;
          const height = Math.floor(Math.random() * level.maxSide) + 1;
          params = { base, height, kind: "parallelogram_area" };
          correctAnswer = round(base * height);
          question = `מה השטח של מקבילית עם בסיס ${base} וגובה ${height}?`;
          break;
        }

        case "trapezoid": {
          const base1 = Math.floor(Math.random() * level.maxSide) + 1;
          const base2 = Math.floor(Math.random() * level.maxSide) + 1;
          const height = Math.floor(Math.random() * level.maxSide) + 1;
          params = { base1, base2, height, kind: "trapezoid_area" };
          correctAnswer = round(((base1 + base2) * height) / 2);
          question = `מה השטח של טרפז עם בסיסים ${base1} ו-${base2} וגובה ${height}?`;
          break;
        }

        case "circle": {
          const radius =
            Math.floor(Math.random() * (level.maxSide / 2)) + 1;
          const useStory = allowStory && Math.random() < 0.4;

          params = {
            radius,
            kind: useStory ? "story_circle_area" : "circle_area",
          };
          correctAnswer = round(PI * radius * radius);

          if (useStory) {
            question = `מגרש משחקים עגול בעל רדיוס ${radius} מטר. מה שטח המגרש? (π = 3.14)`;
          } else {
            question = `מה השטח של עיגול עם רדיוס ${radius}? (π = 3.14)`;
      }
      break;
    }

        default: {
          const side = Math.floor(Math.random() * level.maxSide) + 1;
          params = { side, kind: "square_area" };
          correctAnswer = round(side * side);
          question = `מה השטח של ריבוע עם צלע ${side}?`;
        }
      }
      break;
    }

    // ===================== PERIMETER =====================
    case "perimeter": {
      switch (shape) {
        case "square": {
          const side = Math.floor(Math.random() * level.maxSide) + 1;
          const useStory = allowStory && Math.random() < 0.4;

          params = { side, kind: useStory ? "story_square_perimeter" : "square_perimeter" };
          correctAnswer = round(side * 4);

          if (useStory) {
            question = `ליאו רוצה לשים גדר מסביב לגינה בצורת ריבוע, אורך כל צלע הוא ${side} מטר. מה אורך הגדר הכולל שהוא צריך?`;
          } else {
            question = `מה ההיקף של ריבוע עם צלע ${side}?`;
          }
          break;
        }

        case "rectangle": {
          const length = Math.floor(Math.random() * level.maxSide) + 1;
          const width = Math.floor(Math.random() * level.maxSide) + 1;
          const useStory = allowStory && Math.random() < 0.5;

          params = {
            length,
            width,
            kind: useStory ? "story_rectangle_perimeter" : "rectangle_perimeter",
          };
          correctAnswer = round((length + width) * 2);

          if (useStory) {
            question = `גינה מלבנית מוקפת בגדר. האורך ${length} מטר והרוחב ${width} מטר. כמה מטרים של גדר צריך בסך הכל?`;
          } else {
            question = `מה ההיקף של מלבן עם אורך ${length} ורוחב ${width}?`;
          }
          break;
        }

        case "triangle": {
          const side1 = Math.floor(Math.random() * level.maxSide) + 1;
          const side2 = Math.floor(Math.random() * level.maxSide) + 1;
          const side3 = Math.floor(Math.random() * level.maxSide) + 1;
          params = { side1, side2, side3, kind: "triangle_perimeter" };
          correctAnswer = round(side1 + side2 + side3);
          question = `מה ההיקף של משולש עם צלעות ${side1}, ${side2}, ${side3}?`;
          break;
        }

        case "circle": {
          const radius =
            Math.floor(Math.random() * (level.maxSide / 2)) + 1;
          const useStory = allowStory && Math.random() < 0.4;

          params = { radius, kind: useStory ? "story_circle_perimeter" : "circle_perimeter" };
          correctAnswer = round(2 * PI * radius);

          if (useStory) {
            question = `שביל הליכה מקיף אגם עגול בעל רדיוס ${radius} מטר. כמה מטרים אורך השביל? (π = 3.14)`;
          } else {
            question = `מה ההיקף של עיגול עם רדיוס ${radius}? (π = 3.14)`;
      }
      break;
    }

        default: {
          const side = Math.floor(Math.random() * level.maxSide) + 1;
          params = { side, kind: "square_perimeter" };
          correctAnswer = round(side * 4);
          question = `מה ההיקף של ריבוע עם צלע ${side}?`;
        }
      }
      break;
    }

    // ===================== VOLUME =====================
    case "volume": {
      switch (shape) {
        case "cube": {
          const side =
            Math.floor(Math.random() * (level.maxSide / 2)) + 1;
          const useStory = allowStory && Math.random() < 0.4;

          params = { side, kind: useStory ? "story_cube_volume" : "cube_volume" };
          correctAnswer = round(side * side * side);

          if (useStory) {
            question = `קופסת משחקים בצורת קובייה, אורך הצלע שלה ${side} ס"מ. מה נפח הקופסה בס"מ מעוקב?`;
          } else {
            question = `מה הנפח של קובייה עם צלע ${side}?`;
          }
          break;
        }

        case "rectangular_prism": {
          const length =
            Math.floor(Math.random() * (level.maxSide / 2)) + 1;
          const width =
            Math.floor(Math.random() * (level.maxSide / 2)) + 1;
          const height =
            Math.floor(Math.random() * level.maxSide) + 1;
          const useStory = allowStory && Math.random() < 0.5;

          params = {
            length,
            width,
            height,
            kind: useStory ? "story_box_volume" : "rectangular_prism_volume",
          };
          correctAnswer = round(length * width * height);

          if (useStory) {
            question = `ליאו אורז צעצועים בקופסת קרטון בצורת תיבה באורך ${length} ס"מ, רוחב ${width} ס"מ וגובה ${height} ס"מ. מה נפח הקופסה בס"מ מעוקב?`;
          } else {
            question = `מה הנפח של תיבה עם אורך ${length}, רוחב ${width} וגובה ${height}?`;
          }
          break;
        }

        case "cylinder": {
          const radius =
            Math.floor(Math.random() * (level.maxSide / 3)) + 1;
          const height =
            Math.floor(Math.random() * level.maxSide) + 1;
          params = { radius, height, kind: "cylinder_volume" };
          correctAnswer = round(PI * radius * radius * height);
          question = `מה הנפח של גליל עם רדיוס ${radius} וגובה ${height}? (π = 3.14)`;
          break;
        }

        case "sphere": {
          const radius =
            Math.floor(Math.random() * (level.maxSide / 3)) + 1;
          params = { radius, kind: "sphere_volume" };
          correctAnswer = round((4 / 3) * PI * radius * radius * radius);
          question = `מה הנפח של כדור עם רדיוס ${radius}? (π = 3.14)`;
          break;
        }

        default: {
          const length =
            Math.floor(Math.random() * (level.maxSide / 2)) + 1;
          const width =
            Math.floor(Math.random() * (level.maxSide / 2)) + 1;
          const height =
            Math.floor(Math.random() * level.maxSide) + 1;
          params = { length, width, height, kind: "rectangular_prism_volume" };
          correctAnswer = round(length * width * height);
          question = `מה הנפח של תיבה עם אורך ${length}, רוחב ${width} וגובה ${height}?`;
        }
      }
      break;
    }

    // ===================== ANGLES =====================
    case "angles": {
      const angle1 = Math.floor(Math.random() * 61) + 40;
      const maxAngle2 = 160 - angle1;
      const angle2 = Math.floor(Math.random() * (maxAngle2 - 19)) + 20;
      const angle3 = 180 - angle1 - angle2;

      params = { angle1, angle2, angle3, kind: "triangle_angles" };
      correctAnswer = round(angle3);
      question = `במשולש, זווית אחת היא ${angle1}° וזווית שנייה היא ${angle2}°. מה הזווית השלישית?`;
      break;
    }

    // ===================== PYTHAGORAS =====================
    case "pythagoras": {
      const triples = [
        [3, 4, 5],
        [5, 12, 13],
        [6, 8, 10],
        [8, 15, 17],
      ];
      const [ba, bb, bc] =
        triples[Math.floor(Math.random() * triples.length)];
      const maxK = gradeKey === "g7_8" ? 3 : 2;
      const k = Math.floor(Math.random() * maxK) + 1;

      const a = ba * k;
      const b = bb * k;
      const c = bc * k;

      // לפעמים שואלים על היתר (כמו קודם), לפעמים על אחד הניצבים
      const askLeg =
        allowStory && Math.random() < 0.4; // "שאלה הפוכה" רק בכיתות גבוהות
      if (!askLeg) {
        params = { a, b, c, which: "hypotenuse", kind: "pythagoras_hyp" };
      correctAnswer = round(c);
        question = `במשולש ישר זווית, הניצבים הם ${a} ו-${b}. מה אורך היתר?`;
      } else {
        // נשאל על ניצב חסר
        const missing = Math.random() < 0.5 ? "a" : "b";
        if (missing === "a") {
          params = { a, b, c, which: "leg_a", kind: "pythagoras_leg" };
          correctAnswer = round(a);
          question = `במשולש ישר זווית, היתר הוא ${c} והניצב השני הוא ${b}. מה אורך הניצב החסר?`;
        } else {
          params = { a, b, c, which: "leg_b", kind: "pythagoras_leg" };
          correctAnswer = round(b);
          question = `במשולש ישר זווית, היתר הוא ${c} והניצב השני הוא ${a}. מה אורך הניצב החסר?`;
        }
      }
      break;
    }

    // ===================== DEFAULT =====================
    default: {
      const side = Math.floor(Math.random() * level.maxSide) + 1;
      params = { side, kind: "square_area" };
      correctAnswer = round(side * side);
      question = `מה השטח של ריבוע עם צלע ${side}?`;
    }
  }

  // ===== יצירת תשובות =====
  const wrongAnswers = new Set();
  while (wrongAnswers.size < 3) {
    const variation = Math.floor(Math.random() * 3) + 1;
    const sign = Math.random() > 0.5 ? 1 : -1;
    const delta = Math.max(
      1,
      Math.abs(correctAnswer) * 0.1 * variation
    );
    const wrong = round(correctAnswer + sign * delta);
    if (
      wrong !== correctAnswer &&
      wrong > 0 &&
      !Number.isNaN(wrong) &&
      !wrongAnswers.has(wrong)
    ) {
      wrongAnswers.add(wrong);
    }
  }

  const allAnswers = [correctAnswer, ...Array.from(wrongAnswers)];
  for (let i = allAnswers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [allAnswers[i], allAnswers[j]] = [allAnswers[j], allAnswers[i]];
  }

  return {
    question,
    correctAnswer,
    answers: allAnswers,
    topic: selectedTopic,
    shape,
    params,
  };
}

function getHint(question, topic, gradeKey) {
  if (!question || !question.params) return "";
  switch (topic) {
    case "area":
      if (question.shape === "square") {
        return `שטח ריבוע = צלע × צלע = ${question.params.side} × ${question.params.side}`;
      } else if (question.shape === "rectangle") {
        return `שטח מלבן = אורך × רוחב = ${question.params.length} × ${question.params.width}`;
      } else if (question.shape === "circle") {
        return `שטח עיגול = π × רדיוס² = 3.14 × ${question.params.radius}²`;
      } else if (question.shape === "triangle") {
        return `שטח משולש = (בסיס × גובה) ÷ 2 = (${question.params.base} × ${question.params.height}) ÷ 2`;
      } else if (question.shape === "parallelogram") {
        return `שטח מקבילית = בסיס × גובה = ${question.params.base} × ${question.params.height}`;
      } else if (question.shape === "trapezoid") {
        return `שטח טרפז = ((בסיס1 + בסיס2) × גובה) ÷ 2 = ((${question.params.base1} + ${question.params.base2}) × ${question.params.height}) ÷ 2`;
      }
      break;
    case "perimeter":
      if (question.shape === "square") {
        return `היקף ריבוע = צלע × 4 = ${question.params.side} × 4`;
      } else if (question.shape === "rectangle") {
        return `היקף מלבן = (אורך + רוחב) × 2 = (${question.params.length} + ${question.params.width}) × 2`;
      } else if (question.shape === "circle") {
        return `היקף עיגול = 2 × π × רדיוס = 2 × 3.14 × ${question.params.radius}`;
      } else if (question.shape === "triangle") {
        return `היקף משולש = צלע1 + צלע2 + צלע3 = ${question.params.side1} + ${question.params.side2} + ${question.params.side3}`;
      }
      break;
    case "volume":
      if (question.shape === "cube") {
        return `נפח קובייה = צלע³ = ${question.params.side}³`;
      } else if (question.shape === "cylinder") {
        return `נפח גליל = π × רדיוס² × גובה = 3.14 × ${question.params.radius}² × ${question.params.height}`;
      } else if (question.shape === "sphere") {
        return `נפח כדור = (4/3) × π × רדיוס³ = (4/3) × 3.14 × ${question.params.radius}³`;
      } else if (question.shape === "rectangular_prism") {
        return `נפח תיבה = אורך × רוחב × גובה = ${question.params.length} × ${question.params.width} × ${question.params.height}`;
      }
      break;
    case "angles":
      return `סכום זוויות במשולש = 180°. אם יש ${question.params?.angle1 || 0}° ו-${question.params?.angle2 || 0}°, אז השלישית = 180° - (שתי הזוויות)`;
    case "pythagoras":
      return `משפט פיתגורס: a² + b² = c². כאן: ${question.params?.a || 0}² + ${question.params?.b || 0}² = c²`;
    default:
      return "נסה לחשוב על הנוסחה המתאימה";
  }
  return "נסה לחשוב על הנוסחה המתאימה";
}

// הסבר מפורט צעד-אחר-צעד לפי נושא וכיתה
function getSolutionSteps(question, topic, gradeKey) {
  if (!question || !question.params) return [];
  const p = question.params;
  const shape = question.shape;
  const { correctAnswer } = question;

  const ltr = (expr) => `\u2066${expr}\u2069`; // LRI ... PDI
  const toSpan = (text, key) => (
    <span
      key={key}
      style={{ display: "block", direction: "rtl", unicodeBidi: "plaintext" }}
    >
      {text}
    </span>
  );

  switch (topic) {
    case "area": {
      if (shape === "square") {
        return [
          toSpan("1. נכתוב את הנוסחה: שטח ריבוע = צלע × צלע.", "1"),
          toSpan(`2. נציב: ${ltr(`שטח = ${p.side} × ${p.side}`)}.`, "2"),
          toSpan(`3. נחשב: ${ltr(`${p.side} × ${p.side} = ${correctAnswer}`)}.`, "3"),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות שטח.`, "4"),
        ];
      }
      if (shape === "rectangle") {
        return [
          toSpan("1. נכתוב את הנוסחה: שטח מלבן = אורך × רוחב.", "1"),
          toSpan(`2. נציב: ${ltr(`שטח = ${p.length} × ${p.width}`)}.`, "2"),
          toSpan(`3. נחשב: ${ltr(`${p.length} × ${p.width} = ${correctAnswer}`)}.`, "3"),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות שטח.`, "4"),
        ];
      }
      if (shape === "triangle") {
        return [
          toSpan("1. נכתוב את הנוסחה: שטח משולש = (בסיס × גובה) ÷ 2.", "1"),
          toSpan(`2. נציב: ${ltr(`(${p.base} × ${p.height}) ÷ 2`)}.`, "2"),
          toSpan(
            `3. נחשב: ${ltr(`${p.base} × ${p.height} = ${p.base * p.height}`)}, ואז ${ltr(`${p.base * p.height} ÷ 2 = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות שטח.`, "4"),
        ];
      }
      if (shape === "parallelogram") {
        return [
          toSpan("1. נכתוב את הנוסחה: שטח מקבילית = בסיס × גובה.", "1"),
          toSpan(`2. נציב: ${ltr(`${p.base} × ${p.height}`)}.`, "2"),
          toSpan(`3. נחשב: ${ltr(`${p.base} × ${p.height} = ${correctAnswer}`)}.`, "3"),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות שטח.`, "4"),
        ];
      }
      if (shape === "trapezoid") {
        const sumBases = p.base1 + p.base2;
        return [
          toSpan("1. נכתוב את הנוסחה: שטח טרפז = ((בסיס1 + בסיס2) × גובה) ÷ 2.", "1"),
          toSpan(`2. נציב: ${ltr(`((${p.base1} + ${p.base2}) × ${p.height}) ÷ 2`)}.`, "2"),
          toSpan(
            `3. נחשב: ${ltr(`${p.base1} + ${p.base2} = ${sumBases}`)}, ואז ${ltr(`(${sumBases} × ${p.height}) ÷ 2 = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות שטח.`, "4"),
        ];
      }
      if (shape === "circle") {
        const r2 = p.radius * p.radius;
        return [
          toSpan("1. נכתוב את הנוסחה: שטח עיגול = π × רדיוס².", "1"),
          toSpan(`2. נציב: ${ltr(`שטח = 3.14 × ${p.radius}²`)}.`, "2"),
          toSpan(
            `3. נחשב: ${ltr(`${p.radius}² = ${r2}`)}, ואז ${ltr(`3.14 × ${r2} = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות שטח.`, "4"),
        ];
      }
      break;
    }

    case "perimeter": {
      if (shape === "square") {
        return [
          toSpan("1. נוסחה: היקף ריבוע = צלע × 4.", "1"),
          toSpan(`2. נציב: ${ltr(`${p.side} × 4`)}.`, "2"),
          toSpan(`3. נחשב: ${ltr(`${p.side} × 4 = ${correctAnswer}`)}.`, "3"),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות אורך.`, "4"),
        ];
      }
      if (shape === "rectangle") {
        const sum = p.length + p.width;
        return [
          toSpan("1. נוסחה: היקף מלבן = (אורך + רוחב) × 2.", "1"),
          toSpan(`2. נציב: ${ltr(`(${p.length} + ${p.width}) × 2`)}.`, "2"),
          toSpan(
            `3. נחשב: ${ltr(`${p.length} + ${p.width} = ${sum}`)}, ואז ${ltr(`${sum} × 2 = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות אורך.`, "4"),
        ];
      }
      if (shape === "triangle") {
        return [
          toSpan("1. נוסחה: היקף משולש = צלע1 + צלע2 + צלע3.", "1"),
          toSpan(
            `2. נציב: ${ltr(`${p.side1} + ${p.side2} + ${p.side3}`)}.`,
            "2"
          ),
          toSpan(
            `3. נחשב: ${ltr(`${p.side1} + ${p.side2} + ${p.side3} = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות אורך.`, "4"),
        ];
      }
      if (shape === "circle") {
        return [
          toSpan("1. נוסחה: היקף עיגול = 2 × π × רדיוס.", "1"),
          toSpan(`2. נציב: ${ltr(`2 × 3.14 × ${p.radius}`)}.`, "2"),
          toSpan(
            `3. נחשב: ${ltr(`2 × 3.14 = 6.28`)}, ואז ${ltr(`6.28 × ${p.radius} = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות אורך.`, "4"),
        ];
      }
      break;
    }

    case "volume": {
      if (shape === "cube") {
        return [
          toSpan("1. נוסחה: נפח קובייה = צלע³.", "1"),
          toSpan(`2. נציב: ${ltr(`${p.side}³`)}.`, "2"),
          toSpan(
            `3. נחשב: ${ltr(`${p.side} × ${p.side} × ${p.side} = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות נפח.`, "4"),
        ];
      }
      if (shape === "rectangular_prism") {
        const product = p.length * p.width * p.height;
        return [
          toSpan("1. נוסחה: נפח תיבה = אורך × רוחב × גובה.", "1"),
          toSpan(`2. נציב: ${ltr(`${p.length} × ${p.width} × ${p.height}`)}.`, "2"),
          toSpan(`3. נחשב: ${ltr(`${p.length} × ${p.width} × ${p.height} = ${product}`)}.`, "3"),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות נפח.`, "4"),
        ];
      }
      if (shape === "cylinder") {
        const r2 = p.radius * p.radius;
        return [
          toSpan("1. נוסחה: נפח גליל = π × רדיוס² × גובה.", "1"),
          toSpan(`2. נציב: ${ltr(`3.14 × ${p.radius}² × ${p.height}`)}.`, "2"),
          toSpan(
            `3. נחשב: ${ltr(`${p.radius}² = ${r2}`)}, ואז ${ltr(`3.14 × ${r2} × ${p.height} = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות נפח.`, "4"),
        ];
      }
      if (shape === "sphere") {
        const r3 = p.radius * p.radius * p.radius;
        return [
          toSpan("1. נוסחה: נפח כדור = (4/3) × π × רדיוס³.", "1"),
          toSpan(`2. נציב: ${ltr(`(4/3) × 3.14 × ${p.radius}³`)}.`, "2"),
          toSpan(
            `3. נחשב: ${ltr(`${p.radius}³ = ${r3}`)}, ואז ${ltr(`(4/3) × 3.14 × ${r3} = ${correctAnswer}`)}.`,
            "3"
          ),
          toSpan(`4. התוצאה: ${correctAnswer} יחידות נפח.`, "4"),
        ];
      }
      break;
    }

    case "angles": {
      const angle1 = p.angle1 || 0;
      const angle2 = p.angle2 || 0;
      const sum = angle1 + angle2;
      return [
        toSpan("1. נזכור: סכום הזוויות במשולש = 180°.", "1"),
        toSpan(`2. נציב: ${ltr(`זווית1 = ${angle1}°`)} ו-${ltr(`זווית2 = ${angle2}°`)}.`, "2"),
        toSpan(
          `3. נחשב: ${ltr(`זווית3 = 180° - (${angle1}° + ${angle2}°) = 180° - ${sum}° = ${correctAnswer}°`)}.`,
          "3"
        ),
        toSpan(`4. הזווית השלישית היא ${correctAnswer}°.`, "4"),
      ];
    }

    case "pythagoras": {
      const a = p.a || 0;
      const b = p.b || 0;
      const c = p.c || 0;
      const kind = p.kind || (p.which ? "pythagoras_leg" : "pythagoras_hyp");

      // מצב 1 – מוצאים יתר (קלאסי)
      if (kind === "pythagoras_hyp" || !p.which) {
        const a2 = a * a;
        const b2 = b * b;
        const sum = a2 + b2;
      return [
          toSpan("1. משפט פיתגורס: a² + b² = c².", "1"),
          toSpan(`2. נציב: ${ltr(`${a}² + ${b}² = c²`)}.`, "2"),
          toSpan(`3. נחשב: ${ltr(`${a}² = ${a2}`)} ו-${ltr(`${b}² = ${b2}`)}.`, "3"),
          toSpan(`4. נחבר: ${ltr(`${a2} + ${b2} = ${sum}`)}.`, "4"),
          toSpan(`5. נוציא שורש: ${ltr(`c = √${sum} = ${correctAnswer}`)}.`, "5"),
        ];
      }

      // מצב 2 – מוצאים ניצב חסר (מתקדם יותר)
      const c2 = c * c;
      const missingLeg = p.which === "leg_a" ? "a" : "b";
      const knownLegValue = p.which === "leg_a" ? b : a;
      const known2 = knownLegValue * knownLegValue;
      const diff = c2 - known2;

      return [
        toSpan("1. משפט פיתגורס: a² + b² = c².", "1"),
        toSpan(
          `2. כאן מחפשים ניצב חסר, ולכן נשתמש ב-${missingLeg}² = c² - (הניצב הידוע)².`,
          "2"
        ),
        toSpan(`3. נחשב: ${ltr(`${c}² = ${c2}`)} ו-${ltr(`${knownLegValue}² = ${known2}`)}.`, "3"),
        toSpan(`4. נחסיר: ${ltr(`${c2} - ${known2} = ${diff}`)}.`, "4"),
        toSpan(`5. נוציא שורש: ${ltr(`${missingLeg} = √${diff} = ${correctAnswer}`)}.`, "5"),
      ];
    }

    default:
      return [];
  }

  return [];
}

// "למה טעיתי?" – הסבר קצר לטעות נפוצה
function getErrorExplanation(question, topic, wrongAnswer, gradeKey) {
  if (!question) return "";
  const userAnsNum = Number(wrongAnswer);
  const correctNum = Number(question.correctAnswer);

  switch (topic) {
    case "area":
      if (!Number.isNaN(userAnsNum) && userAnsNum < correctNum) {
        return "נראה ששכחת לכפול או לחלק. בדוק שוב את הנוסחה – האם כפלת/חלקת את כל המספרים?";
      }
      if (!Number.isNaN(userAnsNum) && userAnsNum > correctNum) {
        return "נראה שהוספת במקום לכפול, או שכחת לחלק. בדוק שוב את הנוסחה.";
      }
      return "בדוק שוב: האם השתמשת בנוסחה הנכונה? זכור: שטח ריבוע = צלע × צלע, שטח מלבן = אורך × רוחב, שטח משולש = (בסיס × גובה) ÷ 2.";

    case "perimeter":
      if (!Number.isNaN(userAnsNum) && userAnsNum < correctNum) {
        return "נראה ששכחת לכפול ב-2 (במלבן) או ב-4 (בריבוע), או ששכחת צלע אחת. בדוק שוב.";
      }
      return "בדוק שוב: האם חיברת את כל הצלעות? זכור: היקף ריבוע = צלע × 4, היקף מלבן = (אורך + רוחב) × 2.";

    case "volume":
      if (!Number.isNaN(userAnsNum) && userAnsNum < correctNum) {
        return "נראה ששכחת לכפול באחד הממדים. בדוק שוב את הנוסחה – האם כפלת את כל הממדים?";
      }
      return "בדוק שוב: האם השתמשת בנוסחה הנכונה? זכור: נפח קובייה = צלע³, נפח תיבה = אורך × רוחב × גובה.";

    case "angles":
      if (!Number.isNaN(userAnsNum) && userAnsNum > correctNum) {
        return "נראה שהוספת במקום לחסר. זכור: סכום הזוויות במשולש = 180°, אז הזווית השלישית = 180° - (זווית1 + זווית2).";
      }
      return "בדוק שוב: סכום הזוויות במשולש תמיד שווה ל-180°. חסר את שתי הזוויות מ-180° כדי למצוא את השלישית.";

    case "pythagoras":
      if (!Number.isNaN(userAnsNum) && userAnsNum < correctNum) {
        return "נראה ששכחת להוציא שורש, או שכחת לכפול אחד המספרים בעצמו. זכור: a² + b² = c², אז c = √(a² + b²).";
      }
      return "בדוק שוב: משפט פיתגורס אומר a² + b² = c². חשב את a² ו-b², חבר אותם, ואז הוצא שורש.";

    default:
      return "";
  }
}

// תקציר תיאורטי קצר לפי נושא וכיתה – מוצג לפני השאלה במצב Learning
function getTheorySummary(question, topic, gradeKey) {
  if (!question) return null;

  const lines = [];

  switch (topic) {
    case "area": {
      lines.push("שטח מודד כמה מקום תופסת צורה על המשטח.");
      if (gradeKey === "g3_4") {
        lines.push("ריבוע: שטח = צלע × צלע.");
        lines.push("מלבן: שטח = אורך × רוחב.");
      } else if (gradeKey === "g5_6") {
        lines.push("ריבוע: שטח = צלע × צלע.");
        lines.push("מלבן: שטח = אורך × רוחב.");
        lines.push("משולש: שטח = (בסיס × גובה) ÷ 2.");
      } else {
        // g7_8
        lines.push("ריבוע: שטח = צלע².");
        lines.push("מלבן: שטח = אורך × רוחב.");
        lines.push("משולש: שטח = (בסיס × גובה) ÷ 2.");
        lines.push("מקבילית: שטח = בסיס × גובה.");
        lines.push("טרפז: שטח = ((בסיס1 + בסיס2) × גובה) ÷ 2.");
        lines.push("עיגול: שטח = π × רדיוס².");
      }
      break;
    }

    case "perimeter": {
      lines.push("היקף מודד את אורך המסלול שמקיף את הצורה.");
      lines.push("תמיד מחברים את כל הצלעות.");
      if (gradeKey === "g3_4") {
        lines.push("ריבוע: היקף = צלע × 4.");
        lines.push("מלבן: היקף = (אורך + רוחב) × 2.");
      } else {
        lines.push("בכל צורה: היקף = סכום אורכי כל הצלעות.");
        lines.push("עיגול: היקף = 2 × π × רדיוס.");
      }
      break;
    }

    case "volume": {
      lines.push("נפח מודד כמה מקום תופס גוף במרחב (תלת-מימד).");
      if (gradeKey === "g5_6") {
        lines.push("קובייה: נפח = צלע³.");
        lines.push("תיבה (מלבנית): נפח = אורך × רוחב × גובה.");
      } else {
        lines.push("קובייה: נפח = צלע³.");
        lines.push("תיבה: נפח = אורך × רוחב × גובה.");
        lines.push("גליל: נפח = π × רדיוס² × גובה.");
        lines.push("כדור: נפח = (4/3) × π × רדיוס³.");
      }
      break;
    }

    case "angles": {
      lines.push("בכל משולש: סכום הזוויות הפנימיות הוא 180°.");
      lines.push("אם שתי זוויות ידועות – מוצאים את השלישית בעזרת 180° פחות הסכום שלהן.");
      break;
    }

    case "pythagoras": {
      lines.push("במשולש ישר-זווית: a² + b² = c² (c הוא היתר).");
      lines.push("אם יודעים את שני הניצבים – מוצאים יתר: c = √(a² + b²).");
      lines.push("אם יודעים יתר וניצב – מוצאים ניצב חסר: √(c² - ניצב²).");
      break;
    }

    default: {
      lines.push("חשוב לזכור את הנוסחה המתאימה לנושא ולצורה.");
    }
  }

  return (
    <div>
      <div className="font-bold mb-1 text-[11px]">📘 מה חשוב לזכור?</div>
      <ul className="list-disc pr-4 text-[11px] space-y-0.5 text-right">
        {lines.map((line, idx) => (
          <li key={idx}>{line}</li>
        ))}
      </ul>
    </div>
  );
}

export default function GeometryMaster() {
